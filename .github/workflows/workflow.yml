name: Deployment

on:
  push:
    paths: 
    - ratings-history-expres/**
    - ratings-history-react/**
    - ratings-history-public/**
    - .github/workflows/workflow.yml
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    strategy: 
      matrix:
        node-version: [22.x]

    env:
      PORT: ${{ vars.PORT }}
      OUT_DIR: ${{ vars.OUT_DIR }}
      TEMP_DIR: ${{ vars.TEMP_DIR }}

      KROLL_BOND_LOGIN: ${{ vars.KROLL_BOND_LOGIN }}
      KROLL_BOND_PASS: ${{ vars.KROLL_BOND_PASS }}

      MOODYS_LOGIN: ${{ vars.MOODYS_LOGIN }}
      MOODYS_PASS: ${{ vars.MOODYS_PASS }}
      
      MORNING_STAR_LOGIN: ${{ vars.MORNING_STAR_LOGIN }}
      MORNING_STAR_PASS: ${{ vars.MORNING_STAR_PASS }}

      AMBEST_LOGIN: ${{ vars.AMBEST_LOGIN }}
      AMBEST_PASS: ${{ vars.AMBEST_PASS }}
      
      VITE_BASE_URL: ${{ vars.API_BASE_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
            
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
 
      - name: Install dependencies for backend
        run: npm install
        working-directory: ./ratings-history-express

      - name: Build backend
        run: npm run build
        working-directory: ./ratings-history-express

      - name: Write environment variables to .env file for backend
        working-directory: ./ratings-history-express/dist
        run: |
          touch .env
          echo "PORT=$PORT" >> .env
          echo "OUT_DIR=$OUT_DIR" >> .env
          echo "TEMP_DIR=$TEMP_DIR" >> .env
          echo "KROLL_BOND_LOGIN=$KROLL_BOND_LOGIN" >> .env
          echo "KROLL_BOND_PASS=$KROLL_BOND_PASS" >> .env
          echo "MOODYS_LOGIN=$MOODYS_LOGIN" >> .env
          echo "MOODYS_PASS=$MOODYS_PASS" >> .env
          echo "MORNING_STAR_LOGIN=$MORNING_STAR_LOGIN" >> .env
          echo "MORNING_STAR_PASS=$MORNING_STAR_PASS" >> .env
          echo "AMBEST_LOGIN=$AMBEST_LOGIN" >> .env
          echo "AMBEST_PASS=$AMBEST_PASS" >> .env

      - name: Install dependencies for React admin panel
        run: npm install
        working-directory: ./ratings-history-react

      - name: Write environment variables to .env file for Vite
        working-directory: ./ratings-history-react
        run: |
          touch .env
          echo "VITE_BASE_URL=$VITE_BASE_URL" >> .env
          
      - name: Build React
        run: npm run build
        working-directory: ./ratings-history-react

      - name: Clean up
        run: npm prune --production

      - name: Restart backend
        run: pm2 restart backend
        
      - name: Restart express server for public page
        run: pm2 restart public
